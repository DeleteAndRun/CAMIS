---
title: "Testing approaches under non-proportional hazards"
format: docx
---

# Introduction

In clinical studies with time-to-event outcomes, it is commonly assumed that the hazard functions of the treatment groups are proportional. The standard log-rank test is widely used to test the equivalence of survival functions. However, several scenarios can lead to non-proportional hazards (NPH). For example, a delayed treatment effect may be observed in the treatment arm which can lead to departure from proportionality of the survival curves. Thus there are many tests available in the literature that can handle such scenarios. Most commonly used tests are as follows:\
-   Weighted log-rank test 
-   Restricted Mean Survival Time (RMST) 
-   Milestone survival - Max-Combo test.\
While these tests may be explored in a separate document, this particular document focuses solely on the weighted log-rank test.\
\# Weighted log-rank test Suppose we have two arms, treatment and control, with survival functions $S_1$ & $S_2$ respectively. The null and alternative hypotheses are given as: $$H_0 : S_1(t)=S_2(t) \mbox{    }\forall t  \mbox{ v/s }  H_1 : S_1(t) \neq S_2(t) \mbox{ for some t. }$$ Since alternative hypothesis is composite, it includes multiple scenarios. Hence the power calculation is difficult to implement. One way to tackle this situation is to consider the Lehman alternative given by $H_L : S_1(t)=(S_2(t))^\psi$ for all $t$ where $0<\psi<1$. Alternatively, $$ H_0 : \psi=1  \ v/s \ H_1: \psi<1$$ which implies subjects in treatment arm will have longer survival times than subjects in control arm. For more details, refer to Page 44 of the [link](https://xsliulab.github.io/Workshop/2021/week3/survival-analysis-book.pdf).\
The test statistic for weighted log-rank test is given by, $$ Z = \frac{\sum_{j=1}^{D}w_j(o_{j} -e_j)}{\sqrt{\sum_{j=1}^{D}w_j^2 v_j}} \to N(0,1), \text{under} \ H_0$$ Equivalently, $$ Z^2 = \frac{\big[\sum_{j=1}^{D}w_j(o_j -e_j)\big]^2}{\sum_{j=1}^{D}w_j^2 v_j} \to \chi^2_1, \text{under} \ H_0.$$ Here $t_1<t_2<...<t_D$ be the distinct failure time points of the treatment and control groups together. $o_j$ is the number of deaths, $e_j$ is the expected number of deaths and $v_j$ is the variance of number of deaths in treatment group.\
Different weight functions $w_t$'s are discussed in the literature and a generalized family of weight functions

## Illustration

Weighted log rank testing is implemented using \$\texttt{survival::survdiff()}\$ and \$\texttt{nphRCT::wlrt()}\$ functions available in R.

### Dataset

Data source: https://stats.idre.ucla.edu/sas/seminars/sas-survival/

The data include 500 subjects from the Worcester Heart Attack Study. This study examined several factors, such as age, gender and BMI, that may influence survival time after heart attack. Follow up time for all participants begins at the time of hospital admission after heart attack and ends with death or loss to follow up (censoring). The variables used here are:

-   lenfol: length of followup, terminated either by death or censoring - time variable

-   fstat: loss to followup = 0, death = 1 - censoring variable

-   afb: atrial fibrillation, no = 0, 1 = yes - explanatory variable

-   gender: males = 0, females = 1 - stratification factor

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven)
library(survival)
library(survminer)
library(broom)
library(nphRCT)

knitr::opts_chunk$set(echo = TRUE)

dat <- read_sas(file.path("../data/whas500.sas7bdat"))
head(dat)
```

### Survdiff() function

This function implements the G-rho family of Harrington and Fleming (1982), with weights on each death of $\hat{S}(t)^\rho$ , where $\hat{S}(t)$ is the Kaplan-Meier estimate of survival function at time $t$. If $\rho = 0$, then this is the log-rank or Mantel-Haenszel test, and with $\rho = 1$ it is equivalent to the Peto & Peto modification of the Gehan-Wilcoxon test.

```{r}
WLRtest<-survdiff(Surv(LENFOL,FSTAT)~ AFB,rho = 1,data=dat)
```

```{r}
WLRtest
```

In this illustration, $\rho$ is taken as 1while calculating weights and the weighted log rank test reject the null hypothesis at $5%$ level of significance. i.e.,

### wlrt() function

```{#{r}
#?wlrt() #requires package nphRCT
#WL<-wlrt(formula=Surv(futime,death)~trt,
  #data=data,
  #method="fh",
  #rho = 0,
  #gamma = 0
#)
#WL
#(WL$z)^2  #chi-square value
#1-pchisq((WL$z)^2,1) #p-value corresponding to chi-square
```
