---
title: "Testing approaches under non-proportional hazards"
format: docx
---
# Introduction 
In clinical studies with time-to-event outcomes, it is commonly assumed that the hazard functions of the treatment groups are proportional. The standard log-rank test is widely used to test the equivalence of survival functions.  However, several scenarios can lead to non-proportional hazards (NPH). For example, a delayed treatment effect may be observed in the treatment arm which can lead to departure from proportionality of the survival curves. 
Thus there are many tests available in the literature that can handle such scenarios. Most commonly used tests are as follows:   
- Weighted log-rank test
- Restricted Mean Survival Time (RMST)
- Milestone survival 
- Max-Combo test.  
While these tests may be explored in a separate document, this particular document focuses solely on the weighted log-rank test.  
# Weighted log-rank test
Suppose we have two arms, treatment and control, with survival functions $S_1$ \& $S_2$ respectively. The null and alternative hypotheses are given as:
$$H_0 : S_1(t)=S_2(t) \mbox{    }\forall t  \mbox{ v/s }  H_1 : S_1(t) \neq S_2(t) \mbox{ for some t. }$$ 
Since alternative hypothesis is composite, it includes multiple scenarios. Hence the power calculation is difficult to implement. One way to tackle this situation is to consider the Lehman alternative given by $H_L : S_1(t)=(S_2(t))^\psi$ for all $t$ where $0<\psi<1$. Alternatively, 
$$ H_0 : \psi=1  \ v/s \ H_1: \psi<1$$
which implies subjects in treatment arm will have longer survival times than subjects in control arm. For more details, refer to Page 44 of the [link](https://xsliulab.github.io/Workshop/2021/week3/survival-analysis-book.pdf).  
The test statistic for weighted log-rank test is given by, 
$$ Z = \frac{\sum_{t=1}^{D}w_t(o_{t} -e_t)}{\sqrt{\sum_{t=1}^{D}w_t^2 v_t}} \to N(0,1), \text{under} \ H_0$$
Equivalently, 
$$ Z^2 = \frac{\big[\sum_{t=1}^{D}w_t(o_t -e_t)\big]^2}{\sum_{t=1}^{D}w_t^2 v_t} \to \chi^2_1, \text{under} \ H_0.$$
Here $o_t$ is the number of p

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven)
library(survival)
library(survminer)
library(broom)
library(nphRCT)

knitr::opts_chunk$set(echo = TRUE)

dat <- read_sas(file.path("../data/whas500.sas7bdat"))
head(dat)
```

Weighted log rank testing used in the following scenarios

```{r}
library(survival)
data<-survival::myeloid
```

```{r}
surv_obj<-Surv(data$futime,data$death)
result <- survdiff(surv_obj ~ trt, rho = 0,data = data)
print(result)
```
```{r}
?wlrt() #requires package nphRCT
WL<-wlrt(formula=Surv(futime,death)~trt,
  data=data,
  method="fh",
  rho = 0,
  gamma = 0
)
WL
(WL$z)^2  #chi-square value
1-pchisq((WL$z)^2,1) #p-value corresponding to chi-square
```